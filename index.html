<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strategy Kanban</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { padding-bottom: 110px; font-family: -apple-system, system-ui, sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .tab-active { color: #2563eb; border-top: 3px solid #2563eb; background-color: #f8fafc; }
        .cat-technical { border-left: 5px solid #3b82f6; } 
        .cat-finance { border-left: 5px solid #10b981; }   
        .cat-religion { border-left: 5px solid #8b5cf6; }  
        .cat-howto { border-left: 5px solid #f59e0b; }     
        .cat-entertainment { border-left: 5px solid #ef4444; }

        .swipe-container { position: relative; margin-bottom: 1rem; background: #fee2e2; border-radius: 1.25rem; overflow: hidden; }
        .swipe-content { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); background: white; z-index: 2; position: relative; }
        .delete-action { 
            position: absolute; right: 0; top: 0; height: 70px; width: 80px; 
            display: flex; align-items: center; justify-content: center;
            background: #ef4444; color: white; font-weight: 800; font-size: 14px; 
            z-index: 1; border-radius: 0 1.25rem 0 1.25rem;
        }
        .nav-counter { font-size: 11px; font-weight: 900; color: #94a3b8; }
        .tab-active .nav-counter { color: #2563eb; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <header class="bg-white p-4 shadow-sm sticky top-0 z-30">
        <div class="flex justify-between items-center mb-2">
            <div>
                <h1 id="view-title" class="text-xl font-bold leading-none text-blue-600">‰∫àÂÆö„É™„Çπ„Éà</h1>
                <p id="sync-status" class="text-[9px] text-gray-400 font-bold uppercase mt-1">Ready</p>
                <p id="last-saved" class="text-[8px] text-blue-400 font-medium">Sync: ---</p>
            </div>
            <div class="flex gap-2">
                 <button onclick="downloadBackup()" class="bg-blue-50 text-blue-600 p-2.5 rounded-full">üì•</button>
                 <button onclick="saveToGitHub()" class="bg-green-600 text-white p-2.5 rounded-full shadow-lg active:scale-95">üíæ</button>
                 <button onclick="setupToken()" class="bg-gray-100 p-2.5 rounded-full">üîë</button>
            </div>
        </div>
        <input id="search-input" type="text" oninput="renderBoard()" placeholder="Ê§úÁ¥¢..." class="w-full bg-gray-100 border-none rounded-xl p-3 text-sm outline-none">
    </header>

    <main class="p-4" id="list-container"></main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around items-center h-24 shadow-lg z-20 pb-8">
        <button onclick="changeTab('to-read')" class="nav-btn flex flex-col items-center flex-1" id="btn-to-read">
            <span class="text-xl">üìÖ</span><span class="nav-counter" id="count-to-read">0</span>
        </button>
        <button onclick="changeTab('progress')" class="nav-btn flex flex-col items-center flex-1" id="btn-progress">
            <span class="text-xl">üìñ</span><span class="nav-counter" id="count-progress">0</span>
        </button>
        <button onclick="changeTab('complete')" class="nav-btn flex flex-col items-center flex-1" id="btn-complete">
            <span class="text-xl">‚úÖ</span><span class="nav-counter" id="count-complete">0</span>
        </button>
    </nav>

    <script>
        // --- ENSURE THESE MATCH GITHUB EXACTLY ---
        const GITHUB_CONFIG = { 
            token: localStorage.getItem('gh_token') || '', 
            owner: 'iuchino', 
            repo: 'content-kanban', 
            path: 'data.json' 
        };

        let myContent = [];
        let currentTab = 'to-read';
        let touchStartX = 0;

        function updateUI() {
            document.getElementById('count-to-read').innerText = myContent.filter(i => i.status === 'to-read').length;
            document.getElementById('count-progress').innerText = myContent.filter(i => i.status === 'progress').length;
            document.getElementById('count-complete').innerText = myContent.filter(i => i.status === 'complete').length;
            renderBoard();
        }

        async function loadData() {
            if(!GITHUB_CONFIG.token) return;
            document.getElementById('sync-status').innerText = "CONNECTING...";
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}?cb=${Date.now()}`;
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${GITHUB_CONFIG.token.trim()}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (res.ok) {
                    const data = await res.json();
                    myContent = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                    updateUI();
                    document.getElementById('sync-status').innerText = "CLOUD SYNC ACTIVE";
                    document.getElementById('last-saved').innerText = `Sync: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                }
            } catch (e) { document.getElementById('sync-status').innerText = "SYNC ERROR"; }
        }

        async function saveToGitHub() {
            if(!GITHUB_CONFIG.token) { alert("Token required"); return; }
            document.getElementById('sync-status').innerText = "UPLOADING...";
            
            try {
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
                
                // Fetch fresh SHA
                const getRes = await fetch(url + `?cb=${Date.now()}`, { 
                    headers: { 'Authorization': `Bearer ${GITHUB_CONFIG.token.trim()}` }
                });
                if(!getRes.ok) throw new Error("Fetch failed");
                const fileData = await getRes.json();
                
                const jsonString = JSON.stringify(myContent, null, 2);
                const content = btoa(unescape(encodeURIComponent(jsonString)));

                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${GITHUB_CONFIG.token.trim()}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({ message: "Sync Update", content, sha: fileData.sha })
                });

                if(res.ok) {
                    alert("‚úÖ Saved to GitHub");
                    loadData();
                } else {
                    const err = await res.json();
                    alert(`Error: ${err.message}`);
                }
            } catch (e) { alert("Network Error: Check Connection"); }
        }

        function renderBoard() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            const search = document.getElementById('search-input').value.toLowerCase();
            
            myContent.filter(item => item.status === currentTab && item.title.toLowerCase().includes(search))
            .forEach(item => {
                const card = document.createElement('div');
                card.className = 'swipe-container';
                card.innerHTML = `
                    <div class="delete-action" onclick="deleteItem(${item.id})">DEL</div>
                    <div class="swipe-content bg-white p-5 border-b cat-${item.goal || 'entertainment'}" ontouchstart="tS(event)" ontouchmove="tM(event, this)">
                        <h3 class="font-bold text-gray-800 pr-10">${item.title}</h3>
                        ${item.url ? `<a href="${item.url}" target="_blank" class="text-[10px] text-blue-500 underline truncate block my-1">üîó Amazon Link</a>` : ''}
                        <textarea onchange="updateNote(${item.id}, this.value)" class="w-full text-sm p-2 bg-gray-50 rounded mt-2 h-20 border-none outline-none">${item.note || ''}</textarea>
                        <div class="flex gap-2 mt-2">
                            ${currentTab==='progress' ? `<button onclick="moveBack(${item.id})" class="flex-1 bg-gray-100 text-[10px] py-2 rounded">‚Üê BACK</button>` : ''}
                            ${currentTab!=='complete' ? `<button onclick="moveItem(${item.id})" class="flex-[2] bg-blue-600 text-white text-[10px] py-2 rounded font-bold">NEXT ‚Üí</button>` : 
                            `<select onchange="updateRating(${item.id}, this.value)" class="w-full bg-yellow-50 text-[10px] py-2 rounded"><option value="0">Rating</option>${[1,2,3,4,5].map(n=>`<option value="${n}" ${item.rating==n?'selected':''}>‚≠ê ${n}</option>`).join('')}</select>`}
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        function tS(e) { touchStartX = e.touches[0].clientX; }
        function tM(e, el) { let d = touchStartX - e.touches[0].clientX; if(d > 60) el.style.transform = "translateX(-80px)"; else if(d < -20) el.style.transform = "translateX(0px)"; }
        function moveItem(id) { let i = myContent.find(x=>x.id===id); if(i.status==='to-read'){ if(myContent.filter(x=>x.status==='progress').length>=4){alert("Limit 4!"); return;} i.status='progress'; } else { i.status='complete'; } updateUI(); }
        function moveBack(id) { myContent.find(x=>x.id===id).status='to-read'; updateUI(); }
        function updateNote(id, v) { myContent.find(x=>x.id===id).note = v; }
        function updateRating(id, v) { myContent.find(x=>x.id===id).rating = parseInt(v); updateUI(); }
        function deleteItem(id) { if(confirm("Delete?")) { myContent = myContent.filter(x=>x.id!==id); updateUI(); } }
        function changeTab(t) { currentTab = t; document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('tab-active')); document.getElementById(`btn-${t}`).classList.add('tab-active'); updateUI(); }
        function setupToken() { let t = prompt("Token:", GITHUB_CONFIG.token); if(t){ GITHUB_CONFIG.token = t.trim(); localStorage.setItem('gh_token', t.trim()); loadData(); } }
        function downloadBackup() { let b = new Blob([JSON.stringify(myContent, null, 2)], {type: 'application/json'}); let a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `kanban_backup.json`; a.click(); }
        function addNewItem() { let t = document.getElementById('new-title').value; if(!t) return; myContent.push({id:Date.now(), title:t, url:document.getElementById('new-link').value, type:document.getElementById('new-type').value, goal:document.getElementById('new-goal').value, status:'to-read', note:'', rating:0}); document.getElementById('new-title').value=''; updateUI(); }

        loadData();
        changeTab('to-read');
    </script>
</body>
</html>
